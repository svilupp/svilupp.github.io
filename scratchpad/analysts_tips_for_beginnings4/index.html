<!doctype html> <html lang=en > <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-M28VNQP');</script> <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/styles/github.min.css"> <link href="/css/franklin.css" rel=stylesheet > <link href="/css/vela.css" rel=stylesheet > <script src="/libs/vela/jquery.min.js"></script> <link rel=icon  href="/assets/favicon.png"> <title>Jan's Scratchpad</title> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M28VNQP" height=0  width=0  style="display:none;visibility:hidden"></iframe></noscript> <div class="main-nav slideout-menu slideout-menu-left" id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>Scratchpad</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/index.html">Home</a> <li><a href="/scratchpad/">Posts</a> <li><a href="/about/">About</a> <li><a href="/tag/">Tags</a> <li><a href="/privacy_policy/">Privacy Policy</a> <li><a href="/cookie_policy/">Cookie Policy</a> </ul> </nav> </div> <main id=panel  class="slidout-panel slideout-panel-left"> <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">Julia for Analysts: Tips for Better Beginnings - Patterns for Error-free Data Crunching (#4)</h1> <hr> <div class=franklin-content ><h1 id=tldr ><a href="#tldr" class=header-anchor >TL;DR</a></h1> <p>This article is focused mostly on data crunching and speeding up the &quot;time-to-insight&quot;. Stick to DataFramesMeta&#43;StatsPlots, use symbols, DataFramesMeta row-wise macros, and @chain pipelines.</p> <div class=franklin-toc ><ol><li><a href="#always_use_environments">Always Use Environments</a><li><a href="#give_meaningful_and_consistent_names">Give Meaningful and Consistent Names</a><li><a href="#use_symbols_wherever_you_can">Use Symbols Wherever You Can</a><li><a href="#use_dataframesmeta_as_the_center_of_data_universe">Use DataFramesMeta as the Center of Data Universe</a><ol><li><a href="#using_dataframesmeta_statsplots">Using DataFramesMeta, StatsPlots</a><li><a href="#use_macros">Use Macros</a><li><a href="#use_row-wise_macros">Use Row-wise Macros</a><li><a href="#use_chain_pipelines">Use @chain Pipelines</a></ol><li><a href="#use_plotsjl">Use Plots.jl</a><li><a href="#a_common_broadcasting_error">A Common Broadcasting Error</a></ol></div> <h1 id=patterns_for_error-free_data_crunching ><a href="#patterns_for_error-free_data_crunching" class=header-anchor >Patterns for Error-free Data Crunching</a></h1> <p>There are many ways how you can achieve the same in Julia. I found that a few specific tips can reduce the number of errors you make and greatly enhance your &quot;time-to-insight&quot;.</p> <h2 id=always_use_environments ><a href="#always_use_environments" class=header-anchor >Always Use Environments</a></h2> <p>This is a must, no matter how small the analysis is. Julia REPL Pkg mode is super easy to easy and has almost no &quot;costs&quot; &#40;see article #3&#41;.</p> <p>All it takes is:</p> <pre><code class="julia hljs">;cd my/project/path/
]activate .</code></pre> <p>and you will be in your project-dedicated environment. Why the two commands and not just <code>activate</code> with a specific path? I often want to load scripts, data, etc, which I want to address relatively &#40;eg, <code>data_raw/file.csv</code>&#41;, so that is why I change the working directory first.</p> <p>The advanced version would be to always start a new project &#40;analysis&#41; with <code>&#93;generate</code> in the Package mode &#40;see the previous article&#41; or with <a href="https://invenia.github.io/PkgTemplates.jl/">PkgTemplates.jl</a>, but that is sensible only for a bigger piece of work.</p> <h2 id=give_meaningful_and_consistent_names ><a href="#give_meaningful_and_consistent_names" class=header-anchor >Give Meaningful and Consistent Names</a></h2> <p>This is a mouthful. You can only benefit if you choose names that represent the logic/data they hold. Moreover, you should standardize your naming convention, eg, always convert to a snakecase &#40;<code>finance_billings</code> or <code>count_users</code>&#41;.</p> <p>My frequent pattern is to apply the following column name clean-up right after loading a DataFrame:</p> <code>rename&#33;&#40;df,replace.&#40;lowercase.&#40;names&#40;df&#41;&#41;,&quot; &quot;&#61;&gt;&quot;_&quot;,&quot;-&quot;&#61;&gt;&quot;&quot;&#41;&#41;</code> <p>Ideally, the same would hold for your input/output files and the surrounding folder structure &#40;eg, <code>data_raw/finance_billings_20220801.csv</code> and <code>data_processed/forecasting_df_20220801.feather</code>&#41;. </p> <p>It will become self-documenting and your colleagues &#40;and your future self&#33;&#41; will thank you for it.</p> <h2 id=use_symbols_wherever_you_can ><a href="#use_symbols_wherever_you_can" class=header-anchor >Use Symbols Wherever You Can</a></h2> <p>When referring to sub-objects &#40;eg, a column in a DataFrame or using a <code>getfield&#40;&#41;</code> call&#41;, you have a choice between a string &#40;<code>&quot;col_A&quot;</code>&#41; and a symbol &#40;<code>:col_A</code>&#41;. Always go with symbols, ie, use <code>df&#91;&#33;,:a&#93;</code> instead of <code>df&#91;&#33;,&quot;a&quot;&#93;</code>.</p> <p>It&#39;s easier to write &#40;one extra symbol instead of two&#41;, it is &#40;often&#41; done under the hood anyway, but most importantly since I started doing that everywhere in the DataFrames ecosystem I have made way fewer errors &#40;in transforms, in column access, etc.&#41; </p> <p>If you use the <a href="https://bkamins.github.io/julialang/2020/12/24/minilanguage.html">DataFrames.jl minilanguage</a>, always use symbols for column names. If something breaks, you can simply take out the commands and execute them outside of <code>transform&#40;&#41;</code> to debug them properly &#40;especially when broadcasting many functions across many columns&#41;.</p> <h2 id=use_dataframesmeta_as_the_center_of_data_universe ><a href="#use_dataframesmeta_as_the_center_of_data_universe" class=header-anchor >Use DataFramesMeta as the Center of Data Universe</a></h2> <p>DataFrames ecosystem is the data-swiss-army knife that is worth mastering. I found that the below tips have significantly reduced the number of my errors but also increased the predictability of my outputs &#40;ie, with the tips below, I expect to produce a stakeholder-ready load&gt;transform&gt;plot analysis within 30 minutes&#41;.</p> <h3 id=using_dataframesmeta_statsplots ><a href="#using_dataframesmeta_statsplots" class=header-anchor >Using DataFramesMeta, StatsPlots</a></h3> <p>Always start your data work with <code>using DataFramesMeta, StatsPlots</code>. They re-export most packages you need in the beginning, including DataFrames, Chain, and Plots packages.</p> <h3 id=use_macros ><a href="#use_macros" class=header-anchor >Use Macros</a></h3> <p>Use DataFramesMeta &#40;and StatsPlots&#41; macros as much as you can. Read more <a href="https://github.com/JuliaData/DataFramesMeta.jl">here</a> and <a href="https://github.com/JuliaPlots/StatsPlots.jl">here</a>. In particular, learn to master the following ones: </p> <blockquote> <p>@select/@subset/@transform/@by/@orderby/@df</p> </blockquote> <p>For example:</p> <pre><code class="julia hljs">transform(df,:a=&gt;(x-&gt;my_function(x,<span class=hljs-number >1</span>))=&gt;:a_my)
<span class=hljs-comment ># becomes </span>
<span class=hljs-meta >@transform</span> df :a_my=my_function(:a,<span class=hljs-number >1</span>)

subset(df, :A =&gt; a -&gt; a .&lt; <span class=hljs-number >10</span>, :C =&gt; c -&gt; isodd.(c))
<span class=hljs-comment ># becomes </span>
<span class=hljs-meta >@subset</span> df :a.&lt;<span class=hljs-number >10</span> isodd.(:c)
<span class=hljs-comment ># you can add brackets or &amp;&amp; between the conditions for more readability</span></code></pre> <p>In general, you can reduce the amount of brackets, a lot of anonymous functions &#40;vis. examples above&#41;, but most importantly it is a more natural for someone coming from Pandas where we define <code>output &#61; function&#40;input&#41;</code> &#40;eg, in Pandas we would write: <code>df.assign&#40;a_my&#61;lambda x: my_function&#40;x&#91;&quot;a&quot;&#93;,1&#41;&#41;</code>&#41;.</p> <h3 id=use_row-wise_macros ><a href="#use_row-wise_macros" class=header-anchor >Use Row-wise Macros</a></h3> <p>Use <code>@r</code> versions of the above macros to avoid the need to broadcast manually with a dot operator &#40;<a href="https://docs.julialang.org/en/v1/manual/functions/#man-vectorized">docs</a>&#41;.</p> <blockquote> <p>@rselect/@rsubset/@rtransform</p> </blockquote> <p>In other words, save yourself a lot of broadcasting and broadcasting-related errors, especially if you&#39;re coming from the Pandas / Numpy world where broadcasting was often done automatically.</p> <p>For example, the subsetting example above would become <code>@rsubset df :a&lt;10 isodd&#40;:c&#41;</code>. Simply beautiful&#33;</p> <p>One caveat is that it won&#39;t work for methods that require arrays &#40;eg, lead, lag, categorical&#41;, but you can simply just remove the <code>r</code> and it will work again&#33;</p> <p>For keen observers, macro <code>@df</code> does not actually belong to DataFramesMeta but to StatsPlots. However, its application &#40;and reasons for using it&#41; are similar. We can call plots with symbols representing DataFrame&#39;s columns instead of having to provide the whole columns making it, in my opinion, more readable. </p> <p>For example:</p> <pre><code class="julia hljs">bar(my_dataframe_with_poor_name.col_name,my_dataframe_with_poor_name.col_value)
<span class=hljs-comment ># becomes</span>
<span class=hljs-meta >@df</span> my_dataframe_with_poor_name bar(:col_name,:col_value)</code></pre> <h3 id=use_chain_pipelines ><a href="#use_chain_pipelines" class=header-anchor >Use @chain Pipelines</a></h3> <p>I cannot overemphasize how clean and practical it is to write your data manipulation in a pipeline in a non-mutating way &#40;ie, not having 10 different DataFrames, each for a different chart ala <code>new_df2&#61;select&#40;df,:a,:b,:c&#41;</code>&#41;.</p> <p>Creating new DataFrames for every task makes it more error-prone, harder to read, harder to re-run, and harder to re-factor into a fully tested data application. Learn <a href="https://github.com/jkrumbiegel/Chain.jl">@chain</a> by heart and you will never look back&#33;</p> <p>Example of data-&gt;plot with @chain macro &#40;not runnable&#41;:</p> <pre><code class="julia hljs"><span class=hljs-comment ># we start with a DataFrame df and return a bar plot (as it&#x27;s the last line executed) </span>
pl=<span class=hljs-meta >@chain</span> df <span class=hljs-keyword >begin</span>
    <span class=hljs-meta >@select</span> :a,:b,:c    <span class=hljs-comment ># select what you need</span>
    <span class=hljs-meta >@by</span> :b :a_sum=sum(:a) :c_min=minimum(:c)  <span class=hljs-comment ># one-line groupby-combine call with two new columns</span>
    <span class=hljs-meta >@orderby</span> :c_min     <span class=hljs-comment ># ordering just for the show</span>
    <span class=hljs-meta >@rtransform</span> :b_double=:b*<span class=hljs-number >2</span>  <span class=hljs-comment ># Easy transformations</span>
    <span class=hljs-meta >@rsubset</span> :b_double&lt;<span class=hljs-number >20</span>  <span class=hljs-comment ># And easy filtering</span>

    <span class=hljs-comment ># you can even add plots with @df macro</span>
    <span class=hljs-meta >@df</span> bar(:b,:c_min,title=<span class=hljs-string >&quot;My Important Chart&quot;</span>)
<span class=hljs-keyword >end</span></code></pre> <p>It is so elegant, so easy to read and we had to write our DataFrame name <code>df</code> only once at the top, as the result of each line gets passed automatically as the first argument to the function on the next line &#40;hence, the name &quot;chain&quot;&#41;.</p> <p>Fun fact: The above example was written automatically by <a href="https://github.com/features/copilot">Github Copilot</a> in my Neovim &#40;it was 90&#37; of what I wanted&#41;. It plays very well with @chain syntax.</p> <p>Other highlights:</p> <ul> <li><p>Using <code>@aside</code> or potentially <code>@aside @info</code> for introspection or for creating temporary variables for better readability</p> <li><p>Using a one-liner chain without begin-end when a simple pipe operator <code>|&gt;</code> is not suitable &#40;eg, multiple arguments are needed&#41;, eg, <code>@chain &#91;&quot;a&quot;,&quot;B&quot;&#93; join&#40;_,&quot;|&quot;&#41;</code></p> </ul> <h2 id=use_plotsjl ><a href="#use_plotsjl" class=header-anchor >Use Plots.jl</a></h2> <p>There are many great plotting libraries in Julia and I have tried switching 3 times, but, in the end, I always came back to <a href="https://docs.juliaplots.org/">Plots.jl</a>.</p> <p>My reasons to use Plots.jl:</p> <ul> <li><p>Versatile &#40;especially if you have a very specific ask/chart to make; I tend to get stuck with a grammar of graphics-like syntax with our business requirements&#41;</p> <li><p>Used in most packages I use, so it tends to be a requirement anyway</p> <li><p>Easy to switch between different backends but keep the same code, eg, standard <code>GR&#40;&#41;</code> -&gt; interactive <code>PlotlyJS&#40;&#41;</code></p> <li><p>The most intuitive &#40;nicely composable keywords and many aliases&#41; and the easiest to self-help</p> </ul> <p>How to help yourself without googling?</p> <ul> <li><p>Most times I guess the syntax or the right keyword right away</p> <li><p>If not, I jump to docs with <code>?plot</code> and look for the mention of <code>plotattr&#40;:Series&#41;</code>. I use <code>plotattr&#40;...&#41;</code> commands to see all available keywords</p> <li><p>As the last resort, I leverage <code>methods&#40;plot&#41;</code> and <code>edit&#40;&#41;</code> in REPL to quickly pull up the source code / recipe for anything I need</p> </ul> <p>What is the difference between Plots.jl and StatsPlots.jl? </p> <ul> <li><p>Plots.jl is the plotting library that has the lower-level tools and standard plots &#40;eg, <code>bar</code> plot, line plot &#61; <code>plot</code></p> <li><p>StatsPlots.jl is a collection of recipes for common data visualizations, so you can build them faster &#40;eg, <code>groupedhist</code>ogram, <code>groupedbar</code>, and many more; see <a href="https://github.com/JuliaPlots/StatsPlots.jl">StatsPlots.jl</a>&#41;</p> </ul> <h2 id=a_common_broadcasting_error ><a href="#a_common_broadcasting_error" class=header-anchor >A Common Broadcasting Error</a></h2> <p>If you get an error and it&#39;s a MethodError saying that there is no method defined for a Vector &#40;or some collection&#41;, it might be a classic beginner/ex-Python user error. Don&#39;t despair, it takes at most 1-2 weeks to understand why it happens and how to avoid it.</p> <p>You might be calling a method &#40;function&#41; that is defined for individual items &#40;eg, <code>s&#61;&quot;ABC&quot;; lowercase&#40;s&#41;</code>&#41; on a collection of items &#40;eg, <code>s_vec&#61;&#91;&quot;ABC&quot;,&quot;DEF&quot;&#93;; lowercase&#40;s_vec&#41;</code> would give you such an error&#41;.</p> <p>Often you can get away with a quick fix. Add a dot between the function name and the opening bracket to signal that Julia should apply this function to all items in the collection &#40;eg, <code>s_vec&#61;&#91;&quot;ABC&quot;,&quot;DEF&quot;&#93;; lowercase.&#40;s_vec&#41;</code> - notice the <code>.</code> after lowercase&#41;. </p> <p>Read more in the <a href="https://docs.julialang.org/en/v1/manual/functions/#man-vectorized">Julia manual</a>.</p> <div class=page-foot > <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Jan Siml. Last modified: November 21, 2023. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. See the <a href="/privacy_policy/">Privacy Policy</a> </div> </div> </main> <script src="/libs/vela/metisMenu.min.js"></script> <script src="/libs/vela/slideout.min.js"></script> <script src="/libs/highlight/highlight.min.js"></script> <script>hljs.highlightAll();hljs.configure({tabReplace: ' '});</script>