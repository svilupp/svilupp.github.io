<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/styles/github.min.css"> <!-- bootstrap@5.3.1 and bootstrap icon@1.10--> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel=stylesheet  integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin=anonymous > <link rel=stylesheet  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"> <link rel=stylesheet  href="/css/style.css"> <link rel=stylesheet  href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"> <link data-n-head=ssr  rel=stylesheet  href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons"> <link rel=stylesheet  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin=anonymous  referrerpolicy=no-referrer  /> <link rel=stylesheet  href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin=anonymous  referrerpolicy=no-referrer  /> <!-- favicon generated through https://realfavicongenerator.net/--> <link rel=apple-touch-icon  sizes=180x180  href="/assets/icon/apple-touch-icon.png"> <link rel=icon  type="image/png" sizes=32x32  href="/assets/icon/favicon-32x32.png"> <link rel=icon  type="image/png" sizes=16x16  href="/assets/icon/favicon-16x16.png"> <link rel=manifest  href="/assets/icon/site.webmanifest"> <link rel=mask-icon  href="/assets/icon/safari-pinned-tab.svg" color="#5bbad5"> <meta name=msapplication-TileColor  content="#da532c"> <meta name=theme-color  content="#ffffff"> <link rel=stylesheet  href="/_css/custom.css"> <title>Automatically Saving Conversations with PromptingTools.jl and AIHelpMe.jl</title> <header data-bs-theme=dark > <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark"> <div class=container > <a href="/" class="navbar-brand d-flex align-items-center"> <svg xmlns="http://www.w3.org/2000/svg" width=16  height=16  fill=currentColor  class="bi bi-journal-text me-2" viewBox="0 0 16 16"> <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/> <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/> <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/> </svg> <strong>siml.earth</strong> </a> <button class=navbar-toggler  type=button  data-bs-toggle=collapse  data-bs-target="#navbarCollapse" aria-controls=navbarCollapse  aria-expanded=false  aria-label="Toggle navigation"> <span class=navbar-toggler-icon ></span> </button> <div class="collapse navbar-collapse" id=navbarCollapse > <ul class="navbar-nav me-auto mb-2 mb-md-0"> <li class="nav-item dropdown"> <a class="nav-link dropdown-toggle fw-bold" href="#" id=navbarDropdown  role=button  data-bs-toggle=dropdown  aria-expanded=false > Sites </a> <ul class=dropdown-menu  aria-labelledby=navbarDropdown > <li><h6 class=dropdown-header >Choose a Site</h6> <li><a class=dropdown-item  href="/jan/">Jan's Site</a> <li><a class=dropdown-item  href="/ann/">Ann's Site</a> </ul> <li class=nav-item ><hr class="dropdown-divider mx-2"> <li class=nav-item > <span class="navbar-text px-2 fw-bold d-flex align-items-center">Jan's:</span> <li class=nav-item > <a class=nav-link  aria-current=page  href="/jan/">Home</a> <li class=nav-item > <a class=nav-link  href="/jan/scratchpad/">Posts</a> <li class=nav-item > <a class=nav-link  href="/jan/wip/">Work in Progress</a> <li class=nav-item > <a class=nav-link  href="/jan/about/">About</a> <li class=nav-item > <a class=nav-link  href="/jan/tags/">Tags</a> <li class=nav-item > <a class=nav-link  href="/jan/privacy_policy/">Privacy Policy</a> <li class=nav-item > <a class=nav-link  href="/jan/cookie_policy/">Cookie Policy</a> </ul> </div> </div> </nav> </header> <div class="container py-3 px-3 mx-auto"> <div class=franklin-content ><h1 id=tldr ><a href="#tldr" class=header-anchor >TL;DR</a></h1> <p>Learn how to automatically save conversations with PromptingTools.jl. By saving conversations, you can contribute to building a dataset for fine-tuning a Julia-specific language model. This tutorial provides code examples to get you started</p> <p><div class=franklin-toc ><ol><li><a href="#tldr">TL;DR</a><ol><li><a href="#introduction">Introduction</a><li><a href="#defining_a_custom_schema_for_saving_conversations">Defining a Custom Schema for Saving Conversations</a><ol><li><a href="#example_1_saving_conversations_with_aigenerate">Example 1: Saving Conversations with <code>aigenerate</code></a></ol><li><a href="#example_2_registering_a_traced_model">Example 2: Registering a Traced Model</a><li><a href="#loading_conversations">Loading Conversations</a><li><a href="#exporting_conversations_in_sharegpt_format">Exporting Conversations in ShareGPT Format</a><li><a href="#saving_aihelpme_conversations">Saving AIHelpMe Conversations</a><li><a href="#sharing_the_conversations">Sharing The Conversations</a><li><a href="#conclusion">Conclusion</a></ol></ol></div> </p> <h2 id=introduction ><a href="#introduction" class=header-anchor >Introduction</a></h2> <p>Recently, there have been exciting discussions about fine-tuning a language model for the Julia programming language &#40;see <a href="https://discourse.julialang.org/t/an-llm-fine-tuned-for-julia-call-for-comments-help/113462/8">here</a>&#41;. </p> <p>As part of this effort, we need a high-quality dataset of GOOD conversations related to Julia. One way to contribute to this effort is to start logging conversations with Large Language Models &#40;LLMs&#41; that are relevant to Julia. </p> <p>In this blog post, we will explore how to automatically save conversations using PromptingTools.jl and AIHelpMe.jl, a powerful Julia package for interacting with language models. By saving these conversations, we can build a valuable dataset for fine-tuning a Julia-specific language model.</p> <h2 id=defining_a_custom_schema_for_saving_conversations ><a href="#defining_a_custom_schema_for_saving_conversations" class=header-anchor >Defining a Custom Schema for Saving Conversations</a></h2> <p>A lesser-known feature, PromptingTools has a custom callback system that allows us to define custom schemas that will then call your arbitrary functions before and after each LLM call &#40;it&#39;s used mostly for observability&#41;.</p> <p>To save conversations, we need to define a custom schema that wraps our normal prompt schema. We can do this by creating a new struct <code>SaverSchema</code> that inherits from <code>PT.AbstractTracerSchema</code>.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Dates
<span class=hljs-keyword >using</span> JSON3
<span class=hljs-keyword >using</span> PromptingTools
<span class=hljs-keyword >const</span> PT = PromptingTools

<span class=hljs-keyword >const</span> SAVE_DIR = <span class=hljs-string >&quot;finetune_julia&quot;</span>

<span class=hljs-meta >@kwdef</span> <span class=hljs-keyword >struct</span> SaverSchema &lt;: PT.AbstractTracerSchema
    schema::PT.AbstractPromptSchema
<span class=hljs-keyword >end</span></code></pre> <p>Any call to this schema triggers a call to function <code>initialize_tracer</code> before the LLM call and to <code>finalize_tracer</code> after the LLM call.</p> <p>In our case, we want to overload the <code>finalize_tracer</code> function to save the conversation after the LLM call.</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> PT.finalize_tracer(
    tracer_schema::SaverSchema, 
    tracer, 
    msg_or_conv; 
    tracer_kwargs=<span class=hljs-built_in >NamedTuple</span>(), 
    model=<span class=hljs-string >&quot;&quot;</span>, 
    kwargs...
)
    <span class=hljs-comment ># We already captured all kwargs, they are already in `tracer`, we can ignore tracer_kwargs in this implementation</span>

    time_received = Dates.format(now(), <span class=hljs-string >&quot;YYYYmmdd_HHMMSS&quot;</span>)
    path = joinpath(SAVE_DIR, <span class=hljs-string >&quot;conversation__<span class=hljs-subst >$(model)</span>__<span class=hljs-subst >$(time_received)</span>.json&quot;</span>)
    conv = msg_or_conv <span class=hljs-keyword >isa</span> <span class=hljs-built_in >AbstractVector</span> ? msg_or_conv : [msg_or_conv]
    PT.save_conversation(path, conv)

    <span class=hljs-keyword >return</span> msg_or_conv
<span class=hljs-keyword >end</span></code></pre> <h3 id=example_1_saving_conversations_with_aigenerate ><a href="#example_1_saving_conversations_with_aigenerate" class=header-anchor >Example 1: Saving Conversations with <code>aigenerate</code></a></h3> <p>Now that we have defined our custom schema, we can use it to save conversations with <code>aigenerate</code>. We need to explicitly provide the <code>SaverSchema</code> instance to <code>aigenerate</code> along with the input prompt.</p> <pre><code class="julia hljs">schema = SaverSchema(PT.OpenAISchema())
msg = aigenerate(schema, <span class=hljs-string >&quot;Say hi&quot;</span>, model=<span class=hljs-string >&quot;gpt3t&quot;</span>, return_all=<span class=hljs-literal >true</span>)</code></pre> <p>When you call this function, it will save the conversation to the folder defined in <code>SAVE_DIR</code>.</p> <p>One gotcha, if you send multiple messages in the save convo, is that all turns will be saved in separate files. The easiest way would be to ignore it and solve it in post-processing &#40;<code>AIMessage</code> have unique IDs so it should be easy to detect&#41; Alternatively, you can save the hash of the content of the first 2-3 messages in the filename to clearly see the continued conversations.</p> <h3 id=example_2_registering_a_traced_model ><a href="#example_2_registering_a_traced_model" class=header-anchor >Example 2: Registering a Traced Model</a></h3> <p>Instead of providing the custom schema every time, we can register a traced model with the custom schema. This way, we can use the model name instead of the schema instance.</p> <pre><code class="julia hljs"><span class=hljs-comment ># Overwrite the schema for this model and define a nice alias</span>
PT.register_model!(; name=<span class=hljs-string >&quot;gpt-3.5-turbo&quot;</span>, schema)
PT.MODEL_ALIASES[<span class=hljs-string >&quot;gpt3t&quot;</span>] = <span class=hljs-string >&quot;gpt-3.5-turbo&quot;</span>

<span class=hljs-comment ># Notice the return_all -&gt; we need to return ALL messages, it would be a useless record otherwise</span>
msg = aigenerate(<span class=hljs-string >&quot;Say hi&quot;</span>, model=<span class=hljs-string >&quot;gpt3t&quot;</span>, return_all=<span class=hljs-literal >true</span>)</code></pre> <p>Conversation gets saved.</p> <h3 id=loading_conversations ><a href="#loading_conversations" class=header-anchor >Loading Conversations</a></h3> <p>Once we have saved conversations, we can load them back into Julia using <code>load_conversation</code>.</p> <pre><code class="julia hljs">conv = PT.load_conversation(<span class=hljs-string >&quot;finetune_julia/conversation__gpt3t__20240425_205853.json&quot;</span>)</code></pre>
<h3 id=exporting_conversations_in_sharegpt_format ><a href="#exporting_conversations_in_sharegpt_format" class=header-anchor >Exporting Conversations in ShareGPT Format</a></h3>
<p>Once we have enough conversation, we will want to export so our finetuning tool can use them.  I would highly recommend Axolotl &#40;see an example from <a href="https://github.com/svilupp/Julia-LLM-Leaderboard/blob/main/experiments/cheater-7b-finetune/lora.yml">my finetune</a>&#41;. </p>
<p>Axolotl can work with instructions &#40;conversations&#41; in ShareGPT format. This is how you can export multiple conversations into the required JSONL file:</p>
<pre><code class="julia hljs">conv1 = [PT.SystemMessage(<span class=hljs-string >&quot;System message 1&quot;</span>), 
         PT.UserMessage(<span class=hljs-string >&quot;User message&quot;</span>), 
         PT.AIMessage(<span class=hljs-string >&quot;AI message&quot;</span>)]
conv2 = [PT.SystemMessage(<span class=hljs-string >&quot;System message 2&quot;</span>), 
         PT.UserMessage(<span class=hljs-string >&quot;User message&quot;</span>), 
         PT.AIMessage(<span class=hljs-string >&quot;AI message&quot;</span>)]
path = joinpath(<span class=hljs-string >&quot;finetune_julia&quot;</span>, <span class=hljs-string >&quot;export_sharegpt.jsonl&quot;</span>)
PT.save_conversations(path, [conv1, conv2])</code></pre>
<h2 id=saving_aihelpme_conversations ><a href="#saving_aihelpme_conversations" class=header-anchor >Saving AIHelpMe Conversations</a></h2>
<p>If you use AIHelpMe, you&#39;re also generating loads of interesting data&#33; The simplest thing for auto-logging your questions is to wrap the entry function <code>aihelp</code> and serialize the whole <code>RAGResult</code> &#40;it has all the diagnostics and underlying information&#41;</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> aih(question; kwargs...)
    result = aihelp(question; return_all=<span class=hljs-literal >true</span>, kwargs...)
    dt = Dates.format(now(), <span class=hljs-string >&quot;YYYYmmdd_HHMMSS&quot;</span>)
    JSON3.write(joinpath(SAVE_DIR, <span class=hljs-string >&quot;aihelp__<span class=hljs-subst >$(dt)</span>.json&quot;</span>), result)
    <span class=hljs-keyword >return</span> result
<span class=hljs-keyword >end</span></code></pre>
<p>To use it, you would replace <code>aihelp&#40;&quot;some question...&quot;&#41;</code> with <code>aih&#40;&quot;some question...&quot;&#41;</code>.</p>
<p>The serialized RAGResult is c. 200kB, but it provides a lot of helpful detail about your question. If you want to save space, save just the individual conversations in <code>result.conversations</code>.</p>
<h2 id=sharing_the_conversations ><a href="#sharing_the_conversations" class=header-anchor >Sharing The Conversations</a></h2>
<p>Where to share these? To be discussed. Come join us on <a href="https://discourse.julialang.org/t/an-llm-fine-tuned-for-julia-call-for-comments-help/113462/8">Discourse</a> or on Julia Slack in #generative-ai.</p>
<h2 id=conclusion ><a href="#conclusion" class=header-anchor >Conclusion</a></h2>
<p>In this blog post, we have seen how to automatically save conversations using PromptingTools.jl. By defining a custom schema and overloading the <code>finalize_tracer</code> function, we can save conversations to files. We can also register a traced model and use it to generate text. Finally, we can load and export conversations in ShareGPT format for finetuning. With AIHelpMe.jl, we can serialize the whole <code>RAGResult</code> with JSON3.</p>
<div class=page-foot >
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Jan Siml. Last modified: November 25, 2024.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div></div> 

<footer class=container >
  <p class=float-end ><a href="#">Back to top</a></p>
  <div class=footer-icons >
      <ul class=social-icons >
          <li><strong>Follow:</strong>
          <li><a href="https://github.com/svilupp" rel="nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width=16  height=16  fill=currentColor  class="bi bi-github" viewBox="0 0 16 16">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg> GitHub</a>
      </ul>
  </div>
  <p class=copyright >&copy; 2023- Company, Inc. · <a href="#">Privacy</a> · <a href="#">Terms</a></p>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity=sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm  crossorigin=anonymous ></script>


  <script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>


<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>